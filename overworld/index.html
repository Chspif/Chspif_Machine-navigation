<!DOCTYPE html>
<html>

<head>
    <title>uNmINeD</title>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

    <!-- OpenLayers  -->
    <link rel="stylesheet" type="text/css" href="lib/ol.css">
    <script src="lib/ol.js"></script>

    <!-- OpenLayers Context Menu -->
    <link href="lib/ol-contextmenu.css" rel="stylesheet">
    <script src="lib/ol-contextmenu.iife.js"></script>

    <!-- Toastify -->
    <script type="text/javascript" src="lib/toastify-js.js"></script>
    <link rel="stylesheet" type="text/css" href="lib/toastify-js.min.css">


    <!-- Map metadata generated by uNmINeD -->
    <script type="text/javascript" src="unmined.map.properties.js"></script>
    <script type="text/javascript" src="unmined.map.regions.js"></script>
    <script type="text/javascript" src="unmined.map.players.js"></script>

    <!-- Custom markers -->
    <script type="text/javascript" src="custom.markers.js"></script>

    <!-- uNmINeD JS and CSS -->
    <script type="text/javascript" src="unmined.js"></script>
    <link rel="stylesheet" type="text/css" href="index.css">
        
    </style>

</head>

<body>
    <div id="map"></div>
    <a href="../index.html" id="back-home" class="back-home-button">返回首页</a>

    <script type="text/javascript">

        document.title = UnminedMapProperties.worldName + " - " + document.title;

        if (UnminedCustomMarkers && UnminedCustomMarkers.isEnabled && UnminedCustomMarkers.markers) {
            UnminedMapProperties.markers = UnminedMapProperties.markers.concat(UnminedCustomMarkers.markers);
        }
        
        if (UnminedPlayers && UnminedPlayers.length > 0) {
            UnminedMapProperties.playerMarkers = Unmined.createPlayerMarkers(UnminedPlayers);
        }

        const mapElement = document.getElementById('map');
        const unmined = new Unmined(mapElement, UnminedMapProperties, UnminedRegions);

        // 处理URL参数，自动定位到指定坐标
        const urlParams = new URLSearchParams(window.location.search);
        const x = urlParams.get('x');
        const z = urlParams.get('z');
        
        if (x && z) {
            // 等待地图加载完成后再设置中心位置
            setTimeout(() => {
                // 设置地图中心到指定坐标
                unmined.center([Number(x), Number(z)]);
                // 设置合适的缩放级别
                if (unmined.olMap && unmined.olMap.getView) {
                    unmined.olMap.getView().setZoom(3);
                }
            }, 100);
        }
        
        // 动态从script.js生成地图标记
        // 定义当前维度
        const currentDimension = 'overworld';
        
        // 确保地图完全初始化后再生成标记
        setTimeout(() => {
            generateDynamicMarkers();
        }, 500);
        
        function generateDynamicMarkers() {
            // 首先尝试从父窗口获取物品数据
            if (window.parent && window.parent.itemsData) {
                processItemsData(window.parent.itemsData);
            } else {
                // 如果无法从父窗口获取，尝试加载script.js文件
                fetch('../script.js')
                    .then(response => response.text())
                    .then(text => {
                        // 提取itemsData数组
                        const match = text.match(/const itemsData = \[(.*?)\];/s);
                        if (match) {
                            try {
                                const itemsData = eval(`[${match[1]}]`);
                                processItemsData(itemsData);
                            } catch (e) {
                                console.error('无法解析itemsData:', e);
                            }
                        }
                    })
                    .catch(error => console.error('无法加载script.js:', error));
            }
        }
        
        function processItemsData(items) {
            console.log('开始处理物品数据:', items);
            
            // 创建新的标记数组
            const dynamicMarkers = [];
            
            items.forEach(item => {
                console.log('处理物品:', item.name);
                item.locations.forEach(location => {
                    console.log('处理位置:', location.name, location.dimension);
                    
                    if (location.dimension === currentDimension) {
                        console.log('匹配当前维度，添加标记:', location.name, location.x, location.z);
                        dynamicMarkers.push({
                            x: location.x,
                            z: location.z,
                            image: "custom.pin.png",
                            imageAnchor: [0.5, 1],
                            imageScale: 0.5,
                            text: location.name,
                            textColor: "#bb86fc", 
                            offsetX: 0,
                            offsetY: 20,
                            font: "bold 20px Calibri,sans serif",
                        });
                    }
                });
            });
            
            console.log('生成的标记:', dynamicMarkers);
            
            // 如果地图已经创建，直接更新标记层
            if (typeof unmined !== 'undefined') {
                console.log('地图实例存在');
                
                // 移除旧的标记层
                if (unmined.markersLayer && unmined.olMap) {
                    console.log('移除旧的标记层');
                    unmined.olMap.removeLayer(unmined.markersLayer);
                    unmined.markersLayer = null;
                }
                
                // 创建新的标记层
                if (dynamicMarkers.length > 0) {
                    console.log('创建新的标记层');
                    unmined.markersLayer = unmined.createMarkersLayer(dynamicMarkers);
                    
                    // 添加新的标记层到地图
                    if (unmined.olMap) {
                        console.log('添加新的标记层到地图');
                        unmined.olMap.addLayer(unmined.markersLayer);
                        
                        // 确保标记层可见
                        unmined.markersLayer.setVisible(true);
                    }
                    
                    // 调整视图到第一个标记的位置
                    console.log('调整视图到标记位置:', dynamicMarkers[0].x, dynamicMarkers[0].z);
                    
                    // 使用setTimeout确保标记已经添加到地图
                    setTimeout(() => {
                        // 设置地图中心到第一个标记的坐标
                        unmined.center([dynamicMarkers[0].x, dynamicMarkers[0].z]);
                        // 设置合适的缩放级别
                        if (unmined.olMap && unmined.olMap.getView) {
                            unmined.olMap.getView().setZoom(3);
                        }
                    }, 100);
                }
            } else {
                console.error('unmined实例不存在');
            }
        }

    </script>
</body>

</html>